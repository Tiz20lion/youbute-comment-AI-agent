<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiz Lion AI Agent - Dashboard</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-subtle': 'bounce-subtle 2s infinite',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-900 text-white">
    <!-- Modern Header -->
    <header class="bg-gray-900/80 backdrop-blur-sm border-b border-gray-700/50 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Left Side - Brand -->
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-3">
                        <div class="relative">
                            <img src="/static/favicon.ico" alt="TizlionAI" class="w-7 h-7">
                            <div class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-gray-900"></div>
                        </div>
                        <div class="flex flex-col">
                            <h1 class="text-lg font-semibold text-white">TizlionAI</h1>
                            <p class="text-xs text-gray-400 leading-none">YouTube Comment Agent</p>
                        </div>
                    </div>
                    
                    <!-- Status Badge -->
                    <div class="hidden sm:flex items-center space-x-2 px-2 py-1 bg-green-500/10 border border-green-500/20 rounded-full">
                        <div id="connectionStatus" class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-xs text-green-400 font-medium">Online</span>
                    </div>
                </div>

                <!-- Right Side - Actions -->
                <div class="flex items-center space-x-3">
                    <!-- Last Updated (Hidden on mobile) -->
                    <div class="hidden md:flex items-center space-x-2 text-xs text-gray-400">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span id="lastUpdated">Loading...</span>
                    </div>
                    
                    <!-- Metrics Button -->
                    <a href="/metrics" class="group relative flex items-center justify-center w-9 h-9 bg-gray-800 hover:bg-gray-700 border border-gray-600 hover:border-gray-500 rounded-lg transition-all duration-200">
                        <svg class="w-4 h-4 text-gray-400 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <!-- Tooltip -->
                        <div class="absolute bottom-full mb-2 left-1/2 transform -translate-x-1/2 px-2 py-1 bg-gray-700 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">
                            Metrics
                        </div>
                    </a>
                    
                    <!-- Settings Button -->
                    <a href="/settings" class="group relative flex items-center justify-center w-9 h-9 bg-gray-800 hover:bg-gray-700 border border-gray-600 hover:border-gray-500 rounded-lg transition-all duration-200">
                        <svg class="w-4 h-4 text-gray-400 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <!-- Tooltip -->
                        <div class="absolute bottom-full mb-2 left-1/2 transform -translate-x-1/2 px-2 py-1 bg-gray-700 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">
                            Settings
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Configuration Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                Configuration Settings
            </h2>
            
            <!-- Desktop: Horizontal layout, Mobile: Vertical stack -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <!-- AI Model Configuration -->
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-semibold flex items-center">
                            <svg class="w-4 h-4 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            AI Model
                        </h3>
                        <span id="currentModelBadge" class="px-2 py-1 bg-green-500 text-white text-xs rounded-full">Active</span>
                    </div>
                    
                    <!-- Compact Current Model -->
                    <div class="mb-3 p-3 bg-gray-900 rounded border">
                        <div id="currentModel" class="text-blue-400 font-medium text-sm truncate">Loading...</div>
                        <div id="currentModelInfo" class="text-xs text-gray-400 mt-1">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                    
                    <!-- Compact Selection -->
                    <div class="space-y-2">
                        <select id="llmModelSelect" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1.5 text-sm text-white focus:outline-none focus:ring-1 focus:ring-blue-500" onchange="showModelPreview()">
                            <option value="">Choose model...</option>
                        </select>
                        
                        <!-- Mini Preview -->
                        <div id="modelPreview" class="bg-blue-900/20 border border-blue-700 rounded p-2 text-xs text-blue-300 hidden">
                            <div id="previewModelInfo"><!-- Dynamic content --></div>
                        </div>
                        
                        <button id="updateLLMBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 px-3 rounded transition-colors disabled:opacity-50" disabled>
                            Update
                        </button>
                    </div>
                </div>

                <!-- System Controls (Compact Desktop Layout) -->
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                    <h3 class="text-sm font-semibold mb-3 flex items-center">
                        <svg class="w-4 h-4 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                        </svg>
                        System Controls
                    </h3>
                    <div class="space-y-3">
                        <!-- Video Processing Control -->
                        <div class="flex items-center justify-between p-2 bg-gray-700/50 rounded border border-gray-600">
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                <span class="text-xs text-gray-300">Max Videos</span>
                                <span id="currentMaxVideos" class="text-xs font-semibold text-green-400">2</span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <input type="number" id="maxVideosInput" min="1" max="50" 
                                       class="w-12 bg-gray-700 border border-gray-600 rounded px-1 py-0.5 text-xs text-center text-white focus:outline-none focus:ring-1 focus:ring-green-500" 
                                       placeholder="2">
                                <button id="updateVideosBtn" class="bg-green-600 hover:bg-green-700 text-white text-xs py-0.5 px-2 rounded transition-colors">
                                    Update
                                </button>
                            </div>
                        </div>
                        
                        <!-- Telegram Bot Control - Mobile-First Design -->
                        <div class="bg-gray-700/50 rounded-lg border border-gray-600 p-3 space-y-3">
                            <!-- Header Row -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <div id="botStatusIcon" class="w-3 h-3 bg-green-500 rounded-full flex-shrink-0"></div>
                                    <span class="text-sm font-medium text-gray-200">Telegram Bot</span>
                                </div>
                                <div id="botStatus" class="text-sm font-semibold">
                                    <span class="text-cyan-400">Loading...</span>
                                </div>
                            </div>

                            <!-- Controls Row - Optimized for Touch -->
                            <div class="flex items-center justify-between">
                                <!-- Toggle with Label -->
                                <div class="flex items-center space-x-3">
                                    <label class="relative inline-flex items-center cursor-pointer group">
                                        <input type="checkbox" id="telegramBotToggle" class="sr-only peer">
                                        <!-- Larger toggle for mobile -->
                                        <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-cyan-500/50 rounded-full peer transition-all peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-500 
                                        sm:w-7 sm:h-4 sm:peer-checked:after:translate-x-3 sm:after:top-[1px] sm:after:left-[1px] sm:after:h-3 sm:after:w-3"></div>
                                        <span class="ml-2 text-sm text-gray-300 group-hover:text-gray-200 transition-colors">Enable</span>
                                    </label>
                                </div>
                                
                                <!-- Restart Button - More prominent on mobile -->
                                <button id="restartBotBtn" class="bg-orange-600 hover:bg-orange-700 active:bg-orange-800 text-white font-medium rounded-lg transition-all duration-200 flex items-center space-x-2 px-3 py-2 text-sm
                                sm:px-2 sm:py-1 sm:text-xs" 
                                title="Restart Bot">
                                    <svg class="w-4 h-4 sm:w-3 sm:h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    <span class="hidden xs:inline sm:hidden md:inline">Restart</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Comment Posting (Compact) -->
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                    <h3 class="text-sm font-semibold mb-3 flex items-center">
                        <svg class="w-4 h-4 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        Comment Posting
                    </h3>
                    <div class="flex items-center justify-between p-2 bg-gray-700/50 rounded border border-gray-600">
                        <div class="flex items-center space-x-2">
                            <div id="commentPostingStatusIcon" class="w-2 h-2 rounded-full bg-gray-500"></div>
                            <span id="commentPostingStatus" class="text-xs font-semibold text-purple-400">Loading...</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="setupOAuth2Btn" class="bg-purple-600 hover:bg-purple-700 text-white text-xs py-0.5 px-2 rounded transition-colors hidden">
                                Setup
                            </button>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="commentPostingToggle" class="sr-only peer" disabled>
                                <div class="w-7 h-4 bg-gray-600 peer-focus:outline-none peer-focus:ring-1 peer-focus:ring-purple-500 rounded-full peer peer-checked:after:translate-x-3 peer-checked:after:border-white after:content-[''] after:absolute after:top-[1px] after:left-[1px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-purple-600"></div>
                            </label>
                        </div>
                    </div>
                    <!-- Hidden help text for screen readers -->
                    <div class="sr-only">
                        <span id="commentPostingHelpText">Enable to post comments</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status Grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
            <!-- System Status -->
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-3">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-400">System</p>
                        <p id="systemStatus" class="text-sm font-bold text-green-400">Running</p>
                    </div>
                    <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                        <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Active Workflows -->
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-3">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-400">Workflows</p>
                        <p id="activeWorkflows" class="text-sm font-bold text-blue-400">0</p>
                    </div>
                    <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center">
                        <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Total Processed -->
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-3">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-400">Processed</p>
                        <p id="totalProcessed" class="text-sm font-bold text-purple-400">0</p>
                    </div>
                    <div class="w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center">
                        <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Success Rate -->
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-3">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-400">Success</p>
                        <p id="successRate" class="text-sm font-bold text-green-400">0%</p>
                    </div>
                    <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                        <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid (Desktop Optimized) -->
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
            <!-- Recent Activity (Ultra Minimal) -->
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                <div class="flex items-center justify-between py-2 border-b border-gray-700 mb-3">
                    <div class="flex items-center space-x-3">
                        <div class="w-2 h-2 bg-orange-500 rounded-full"></div>
                        <span class="text-sm text-gray-300">Recent Activity</span>
                    </div>
                    <div class="text-xs text-orange-400">Live Updates</div>
                </div>
                <div id="recentActivity" class="space-y-2">
                    <div class="text-xs text-gray-400 text-center py-4">No recent activity</div>
                </div>
            </div>
        </div>

        <!-- Live System Logs -->
        <div class="mt-6">
            <div class="bg-gray-800 rounded-lg border border-gray-700">
                <div class="px-4 py-3 border-b border-gray-700 flex justify-between items-center">
                    <h2 class="text-lg font-semibold flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Live System Logs
                    </h2>
                    <div class="flex items-center space-x-2">
                        <div id="logStreamStatus" class="flex items-center text-xs">
                            <div class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                            <span class="text-gray-400">Live</span>
                        </div>
                        <button id="refreshLogsBtn" class="text-blue-400 hover:text-blue-300 text-xs">
                            Refresh
                        </button>
                        <button id="clearLogsBtn" class="text-red-400 hover:text-red-300 text-xs">
                            Clear
                        </button>
                    </div>
                </div>
                <div class="p-4">
                    <div id="systemLogs" class="bg-gray-900 rounded p-3 h-60 overflow-y-auto font-mono text-xs">
                        <p class="text-gray-400">Loading logs...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // Global state
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        let logs = [];
        let recentActivities = []; // Track recent activities

        // Global state for models
        let availableModelsData = {};

        // Manual toggle state tracking to prevent auto-restart
        let manualBotStop = false;
        let lastToggleTime = 0;

        // Initialize WebSocket connection
        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function(event) {
                console.log('WebSocket connected');
                reconnectAttempts = 0;
                updateConnectionStatus(true);
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = function(event) {
                console.log('WebSocket disconnected');
                updateConnectionStatus(false);
                
                // Attempt to reconnect
                if (reconnectAttempts < maxReconnectAttempts) {
                    setTimeout(() => {
                        console.log(`Attempting to reconnect... (${reconnectAttempts + 1}/${maxReconnectAttempts})`);
                        reconnectAttempts++;
                        initWebSocket();
                    }, 3000);
                }
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateConnectionStatus(false);
            };
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            // Handle connection acknowledgment messages
            if (typeof data === 'string') {
                if (data === 'connection' || data.includes('connection')) {
                    console.log('WebSocket connection acknowledged');
                    return;
                }
                try {
                    data = JSON.parse(data);
                } catch (e) {
                    console.log('Received non-JSON WebSocket message:', data);
                    return;
                }
            }
            
            // Ensure data is an object with type property
            if (!data || typeof data !== 'object' || !data.type) {
                console.log('Invalid WebSocket message format:', data);
                return;
            }
            
            switch(data.type) {
                case 'metrics_update':
                    updateMetrics(data.data);
                    break;
                case 'logs_update':
                    if (data.data && Array.isArray(data.data)) {
                        logs = data.data;
                        displayLogs();
                    }
                    break;
                case 'log_entry':
                    addLogEntry(data.data);
                    break;
                case 'telegram_status':
                    // Determine if this is an error status and extract error details
                    const status = data.data.status;
                    const message = data.data.message;
                    const suggestion = data.data.suggestion;
                    const isError = status === 'failed' || status === 'error' || 
                                  (message && (message.includes('rejected') || 
                                              message.includes('Invalid') || 
                                              message.includes('Failed') ||
                                              message.includes('Placeholder') ||
                                              message.includes('not configured')));
                    
                    // Extract specific error details for better user guidance
                    let errorDetails = null;
                    if (isError && message) {
                        // Use the message from the backend directly as it's now more user-friendly
                        errorDetails = message;
                        
                        // Add suggestion if available
                        if (suggestion) {
                            errorDetails += ` - ${suggestion}`;
                        }
                    }
                    
                    updateBotStatus(isError ? 'error' : status, errorDetails);
                    
                    // Show appropriate toast based on status with enhanced error handling
                    const toastType = isError ? 'error' : 'info';
                    let toastMessage = message || 'Telegram bot status changed';
                    
                    // Add action button for error toasts
                    if (isError && suggestion) {
                        showToast(toastMessage, toastType, {
                            action: 'Go to Settings',
                            actionUrl: '/settings'
                        });
                    } else {
                        showToast(toastMessage, toastType);
                    }
                    
                    addRecentActivity({
                        type: 'telegram',
                        message: message || 'Telegram bot status changed',
                        status: isError ? 'error' : status
                    });
                    break;
                case 'config_update':
                    showToast(data.data.message, 'success');
                    loadConfiguration();
                    addRecentActivity({
                        type: 'config',
                        message: data.data.message || 'Configuration updated'
                    });
                    break;
                case 'workflow_update':
                    // Handle workflow updates for Recent Activity
                    if (data.data) {
                        const status = data.data.status || 'unknown';
                        let message = '';
                        if (status === 'running') {
                            message = `Workflow started: ${data.data.workflow_id || 'Unknown'}`;
                        } else if (status === 'completed') {
                            message = `Workflow completed successfully: ${data.data.workflow_id || 'Unknown'}`;
                        } else if (status === 'cancelled') {
                            message = `Workflow cancelled: ${data.data.workflow_id || 'Unknown'}`;
                        } else if (status === 'failed') {
                            message = `Workflow failed: ${data.data.workflow_id || 'Unknown'}`;
                        } else {
                            message = `Workflow ${status}: ${data.data.workflow_id || 'Unknown'}`;
                        }
                        
                        addRecentActivity({
                            type: 'workflow',
                            message: message,
                            status: status,
                            workflow_id: data.data.workflow_id
                        });
                    }
                    break;
                case 'settings_update':
                    // Handle settings updates for Recent Activity
                    addRecentActivity({
                        type: 'settings',
                        message: data.message || 'Settings updated'
                    });
                    showToast(data.message || 'Settings updated', 'success');
                    break;
                case 'error':
                    // Handle error messages for Recent Activity
                    addRecentActivity({
                        type: 'error',
                        message: data.data?.message || data.message || 'System error occurred'
                    });
                    showToast(data.data?.message || data.message || 'Error occurred', 'error');
                    break;
                case 'connection':
                case 'ping':
                case 'pong':
                    // Ignore these connection-related messages
                    break;
                default:
                    console.log('Unknown message type:', data.type);
            }
        }

        // Add new log entry
        function addLogEntry(logEntry) {
            logs.push(logEntry);
            if (logs.length > 100) {
                logs.shift(); // Keep only last 100 logs
            }
            displayLogs();
        }

        // Display logs in the UI
        function displayLogs() {
            const container = document.getElementById('systemLogs');
            if (logs.length === 0) {
                container.innerHTML = '<p class="text-gray-400">No logs available</p>';
                return;
            }

            const logHTML = logs.map(log => {
                const time = new Date(log.timestamp).toLocaleTimeString();
                const levelColor = getLevelColor(log.level);
                return `
                    <div class="mb-1 text-xs">
                        <span class="text-gray-500">[${time}]</span>
                        <span class="${levelColor} font-bold">${log.level.toUpperCase()}</span>
                        <span class="text-blue-400">[${log.module}]</span>
                        <span class="text-gray-300">${log.message}</span>
                    </div>
                `;
            }).join('');

            container.innerHTML = logHTML;
            container.scrollTop = container.scrollHeight; // Auto-scroll to bottom
        }

        // Get color for log level
        function getLevelColor(level) {
            switch(level.toLowerCase()) {
                case 'error': return 'text-red-400';
                case 'warning': case 'warn': return 'text-yellow-400';
                case 'info': return 'text-green-400';
                case 'debug': return 'text-blue-400';
                default: return 'text-gray-400';
            }
        }

        // Load and refresh logs
        async function loadLogs() {
            try {
                const response = await apiRequest('/api/v1/logs?limit=50');
                logs = response.logs || [];
                displayLogs();
            } catch (error) {
                console.error('Failed to load logs:', error);
                addLogEntry({
                    timestamp: new Date().toISOString(),
                    level: 'error',
                    message: 'Failed to load logs from server',
                    module: 'dashboard'
                });
            }
        }

        // Clear logs
        function clearLogs() {
            logs = [];
            displayLogs();
            showToast('Logs cleared', 'info');
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            const logStatus = document.getElementById('logStreamStatus');
            
            if (connected) {
                status.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse';
                logStatus.innerHTML = `
                    <div class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                    <span class="text-gray-400">Live</span>
                `;
            } else {
                status.className = 'w-3 h-3 bg-red-500 rounded-full';
                logStatus.innerHTML = `
                    <div class="w-2 h-2 bg-red-500 rounded-full mr-2"></div>
                    <span class="text-gray-400">Offline</span>
                `;
            }
        }

        // API request helper
        async function apiRequest(endpoint, options = {}) {
            try {
                const response = await fetch(endpoint, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API request failed:', error);
                throw error;
            }
        }

        // Redirect to settings page
        function redirectToSettings() {
            window.location.href = '/settings';
        }

        // Recent Activity Functions
        function addRecentActivity(activity) {
            // Add timestamp if not provided
            if (!activity.timestamp) {
                activity.timestamp = new Date().toISOString();
            }
            
            // Add to beginning of array (most recent first)
            recentActivities.unshift(activity);
            
            // Keep only last 10 activities
            if (recentActivities.length > 10) {
                recentActivities = recentActivities.slice(0, 10);
            }
            
            // Update the display
            displayRecentActivity();
            
            // Save to localStorage
            saveRecentActivity();
        }

        function displayRecentActivity() {
            const container = document.getElementById('recentActivity');
            
            if (recentActivities.length === 0) {
                container.innerHTML = '<div class="text-xs text-gray-400 text-center py-4">No recent activity</div>';
                return;
            }

            const activityHTML = recentActivities.map(activity => {
                const time = new Date(activity.timestamp).toLocaleTimeString('en-US', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                const icon = getActivityIcon(activity.type);
                const colorClass = getActivityColor(activity.type, activity.status);
                
                return `
                    <div class="flex items-center justify-between py-1.5 px-2 rounded hover:bg-gray-700/50 transition-all duration-200">
                        <div class="flex items-center space-x-2 flex-1 min-w-0">
                            <div class="flex-shrink-0">
                                ${icon}
                            </div>
                            <div class="text-xs ${colorClass} truncate">${escapeHtml(activity.message)}</div>
                        </div>
                        <div class="text-xs text-gray-500 ml-2 flex-shrink-0">${time}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = activityHTML;
        }

        function getActivityIcon(type) {
            switch(type) {
                case 'workflow':
                    return '<div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>';
                case 'telegram':
                    return '<div class="w-2 h-2 bg-green-500 rounded-full"></div>';
                case 'config':
                case 'settings':
                    return '<div class="w-2 h-2 bg-purple-500 rounded-full"></div>';
                case 'error':
                    return '<div class="w-2 h-2 bg-red-500 rounded-full"></div>';
                case 'comment':
                    return '<div class="w-2 h-2 bg-yellow-500 rounded-full"></div>';
                case 'system':
                    return '<div class="w-2 h-2 bg-indigo-500 rounded-full"></div>';
                default:
                    return '<div class="w-2 h-2 bg-gray-500 rounded-full"></div>';
            }
        }

        function getActivityColor(type, status) {
            if (type === 'error') return 'text-red-400';
            if (type === 'workflow') {
                if (status === 'completed') return 'text-green-400';
                if (status === 'failed' || status === 'cancelled') return 'text-red-400';
                if (status === 'running') return 'text-blue-400';
            }
            if (type === 'telegram') return 'text-green-400';
            if (type === 'config' || type === 'settings') return 'text-purple-400';
            if (type === 'system') return 'text-indigo-400';
            return 'text-gray-300';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function saveRecentActivity() {
            try {
                localStorage.setItem('recentActivities', JSON.stringify(recentActivities));
            } catch (e) {
                console.log('Failed to save recent activity:', e);
            }
        }

        function loadRecentActivity() {
            try {
                const saved = localStorage.getItem('recentActivities');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (Array.isArray(parsed)) {
                        recentActivities = parsed.slice(0, 10); // Keep only last 10
                        displayRecentActivity();
                    }
                }
            } catch (e) {
                console.log('Failed to load saved activity:', e);
            }
        }

        function initializeRecentActivity() {
            // Load saved activities first
            loadRecentActivity();
            
            // Add welcome message if no activities exist
            if (recentActivities.length === 0) {
                addRecentActivity({
                    type: 'system',
                    message: 'Dashboard loaded successfully'
                });
            }
        }

        // Show model preview when selecting a new model
        function showModelPreview() {
            const modelSelect = document.getElementById('llmModelSelect');
            const selectedModel = modelSelect.value;
            const previewDiv = document.getElementById('modelPreview');
            const previewInfo = document.getElementById('previewModelInfo');
            const updateBtn = document.getElementById('updateLLMBtn');
            
            if (selectedModel && availableModelsData[selectedModel]) {
                const model = availableModelsData[selectedModel];
                previewInfo.innerHTML = `
                    <div class="text-gray-300"><span class="text-blue-400 font-semibold">${model.description}</span></div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Cost:</span>
                        <span class="text-${model.category === 'free' ? 'green' : 'yellow'}-400 font-medium">${model.cost}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Context:</span>
                        <span class="text-purple-400 font-medium">${model.context} tokens</span>
                    </div>
                    <div class="text-sm text-gray-400 mt-2">
                        <span class="text-blue-300">Capabilities:</span> ${model.details}
                    </div>
                `;
                previewDiv.classList.remove('hidden');
                
                // Enable the update button when a model is selected
                updateBtn.disabled = false;
                updateBtn.textContent = 'Update';
            } else {
                previewDiv.classList.add('hidden');
                
                // Disable the update button when no model is selected
                updateBtn.disabled = true;
                updateBtn.textContent = 'Update';
            }
        }

        // Display model details for current model
        function displayCurrentModelDetails(modelName) {
            const detailsDiv = document.getElementById('currentModelDetails');
            const modelInfo = document.getElementById('currentModelInfo');
            
            if (modelName && availableModelsData[modelName]) {
                const model = availableModelsData[modelName];
                modelInfo.innerHTML = `
                    <div class="text-gray-300"><span class="text-green-400 font-semibold">${model.description}</span></div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Cost:</span>
                        <span class="text-${model.category === 'free' ? 'green' : 'yellow'}-400 font-medium">${model.cost}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Context:</span>
                        <span class="text-purple-400 font-medium">${model.context} tokens</span>
                    </div>
                    <div class="text-sm text-gray-400 mt-2">
                        <span class="text-blue-300">Capabilities:</span> ${model.details}
                    </div>
                `;
                detailsDiv.classList.remove('hidden');
            } else {
                detailsDiv.classList.add('hidden');
            }
        }

        // Load configuration details
        async function loadConfiguration() {
            try {
                const config = await apiRequest('/api/v1/configuration/details');
                
                // Store models data globally
                availableModelsData = config.available_models;
                
                // Update current model display with details
                updateCurrentModelDisplay(config.current_llm_model, config.available_models);
                
                // Populate model selector with detailed information
                const modelSelect = document.getElementById('llmModelSelect');
                modelSelect.innerHTML = '';
                
                // Group models by category based on cost
                const freeModels = [];
                const premiumModels = [];
                
                Object.values(config.available_models).forEach(model => {
                    // Categorize based on cost - free models have $0.00/$0.00
                    if (model.cost.includes('$0.00/$0.00')) {
                        freeModels.push(model);
                    } else {
                        premiumModels.push(model);
                    }
                });
                
                // Add free models section
                if (freeModels.length > 0) {
                    const freeGroup = document.createElement('optgroup');
                    freeGroup.label = 'ðŸ†“ FREE MODELS';
                    freeModels.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.name;
                        option.textContent = `${model.description} | Context: ${model.context}`;
                        option.selected = model.name === config.current_llm_model;
                        freeGroup.appendChild(option);
                    });
                    modelSelect.appendChild(freeGroup);
                }
                
                // Add premium models section
                if (premiumModels.length > 0) {
                    const premiumGroup = document.createElement('optgroup');
                    premiumGroup.label = 'ðŸ’Ž PREMIUM MODELS';
                    premiumModels.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.name;
                        option.textContent = `${model.description} | ${model.cost} | Context: ${model.context}`;
                        option.selected = model.name === config.current_llm_model;
                        premiumGroup.appendChild(option);
                    });
                    modelSelect.appendChild(premiumGroup);
                }
                
                // Update max videos display
                document.getElementById('currentMaxVideos').textContent = config.max_videos;
                document.getElementById('maxVideosInput').value = config.max_videos;
                
                // Update bot status
                updateBotStatus(config.telegram_bot_status);
                
                // Update comment posting UI
                updateCommentPostingUI(config);
                
            } catch (error) {
                console.error('Failed to load configuration:', error);
                showToast('Failed to load configuration', 'error');
            }
        }

        // Update bot status display - Updated for mobile-first layout
        function updateBotStatus(status, errorDetails = null) {
            const statusEl = document.getElementById('botStatus');
            const statusIcon = document.getElementById('botStatusIcon');
            const toggle = document.getElementById('telegramBotToggle');
            const restartBtn = document.getElementById('restartBotBtn');
            
            // Find the bot control container using the new layout structure
            const botControlContainer = statusEl.closest('.bg-gray-700\\/50.rounded-lg') || 
                                      statusEl.closest('.bg-gray-700') ||
                                      statusEl.closest('[class*="telegram"]') ||
                                      statusEl.parentElement.parentElement;
            
            // Remove any existing error messaging
            const existingError = botControlContainer.querySelector('.telegram-error-info');
            if (existingError) {
                existingError.remove();
            }
            
            let statusText, iconColor, toggleState, controlsEnabled = true;
            
            // Handle different status states
            switch(status) {
                case 'running':
                    statusText = 'Running';
                    statusEl.innerHTML = `<span class="system-status-running">${statusText}</span>`;
                    iconColor = 'bg-green-500';
                    toggleState = true;
                    break;
                    
                case 'stopped':
                    statusText = 'Stopped';
                    statusEl.innerHTML = `<span class="system-status-stopped">${statusText}</span>`;
                    iconColor = 'bg-red-500';
                    toggleState = false;
                    break;
                    
                case 'failed':
                case 'error':
                    statusText = 'Configuration Error';
                    statusEl.innerHTML = `<span class="system-status-error">${statusText}</span>`;
                    iconColor = 'bg-red-500 animate-pulse';
                    toggleState = false;
                    controlsEnabled = false;
                    
                    // Add enhanced error details for mobile-first layout
                    const errorInfo = document.createElement('div');
                    errorInfo.className = 'telegram-error-info mt-3 p-3 bg-red-900/20 border border-red-500/30 rounded-lg';
                    errorInfo.innerHTML = `
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0">
                                <svg class="w-5 h-5 sm:w-4 sm:h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="font-semibold text-red-200 mb-2 text-sm">Bot startup failed</div>
                                <div class="text-red-300 text-sm sm:text-xs leading-relaxed mb-3 error-message">
                                    ${errorDetails || 'Invalid Telegram configuration detected - please check your bot token and user IDs in Settings.'}
                                </div>
                                <div class="flex flex-col sm:flex-row gap-2">
                                    <a href="/settings" class="inline-flex items-center justify-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-colors error-action-button">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        Fix in Settings
                                    </a>
                                    <button class="inline-flex items-center justify-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg transition-colors sm:hidden error-action-button" onclick="showTelegramSetupGuide()">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Setup Guide
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    botControlContainer.appendChild(errorInfo);
                    break;
                    
                case 'starting':
                    statusText = 'Starting...';
                    statusEl.innerHTML = `<span class="system-status-loading">${statusText}</span>`;
                    iconColor = 'bg-yellow-500 animate-pulse';
                    toggleState = false;
                    controlsEnabled = false;
                    break;
                    
                default:
                    statusText = 'Unknown';
                    statusEl.innerHTML = `<span class="system-status-loading">${statusText}</span>`;
                    iconColor = 'bg-gray-500';
                    toggleState = false;
            }
            
            // Update status icon - use correct size for mobile-first design
            statusIcon.className = `w-3 h-3 ${iconColor} rounded-full flex-shrink-0`;
            
            // Update controls with enhanced disabled state
            if (toggle) {
                toggle.checked = toggleState;
                toggle.disabled = !controlsEnabled;
                const toggleLabel = toggle.closest('label');
                if (!controlsEnabled) {
                    toggle.classList.add('opacity-50', 'cursor-not-allowed');
                    if (toggleLabel) toggleLabel.classList.add('disabled-control');
                } else {
                    toggle.classList.remove('opacity-50', 'cursor-not-allowed');
                    if (toggleLabel) toggleLabel.classList.remove('disabled-control');
                }
            }
            
            if (restartBtn) {
                restartBtn.disabled = !controlsEnabled;
                if (!controlsEnabled) {
                    restartBtn.classList.add('opacity-50', 'cursor-not-allowed', 'disabled-control');
                    restartBtn.title = 'Fix Telegram configuration first';
                } else {
                    restartBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'disabled-control');
                    restartBtn.title = 'Restart Bot';
                }
            }
        }

        // Show Telegram setup guide (mobile helper)
        function showTelegramSetupGuide() {
            const guide = `
                ðŸ“± Quick Telegram Bot Setup:
                
                1. Open Telegram â†’ Search @BotFather
                2. Send /newbot â†’ Choose name & username
                3. Copy the token (looks like: 1234567890:ABC...)
                4. Search @userinfobot â†’ Get your User ID
                5. Paste both in Settings â†’ Update
                
                Need help? Check Settings page for detailed instructions.
            `;
            alert(guide);
        }

        // Handle telegram bot toggle change
        async function handleTelegramBotToggle() {
            const toggle = document.getElementById('telegramBotToggle');
            const action = toggle.checked ? 'start' : 'stop';
            
            // Track manual stop action
            if (action === 'stop') {
                manualBotStop = true;
                lastToggleTime = Date.now();
            } else if (action === 'start') {
                manualBotStop = false;
            }
            
            // Temporarily disable toggle during request
            toggle.disabled = true;
            
            try {
                await controlBot(action);
            } catch (error) {
                // Revert toggle state on error
                toggle.checked = !toggle.checked;
                console.error('Failed to control bot:', error);
                showToast(`Failed to ${action} bot`, 'error');
            } finally {
                // Re-enable toggle after brief delay
                setTimeout(() => {
                    toggle.disabled = false;
                }, 1000);
            }
        }

        // Update current model display
        function updateCurrentModelDisplay(currentModel, availableModels) {
            const modelEl = document.getElementById('currentModel');
            const infoEl = document.getElementById('currentModelInfo');
            
            modelEl.textContent = currentModel;
            
            // Find model details
            const modelData = Object.values(availableModels).find(model => model.name === currentModel);
            if (modelData) {
                infoEl.innerHTML = `
                    <div class="flex items-center mb-1">
                        <span class="text-green-400 mr-1">${modelData.cost.includes('$0.00/$0.00') ? 'ðŸ†“' : 'ðŸ’Ž'}</span>
                        <span>${modelData.description}</span>
                    </div>
                    <div>Cost: <span class="text-cyan-400">${modelData.cost}</span></div>
                    <div>Context: <span class="text-purple-400">${modelData.context}</span></div>
                `;
            } else {
                infoEl.innerHTML = '<div class="text-gray-500">Model details not available</div>';
            }
        }

        // Update LLM model
        async function updateLLMModel() {
            const modelSelect = document.getElementById('llmModelSelect');
            const model = modelSelect.value;
            
            if (!model) {
                showToast('Please select a model', 'warning');
                return;
            }
            
            try {
                const btn = document.getElementById('updateLLMBtn');
                btn.disabled = true;
                btn.textContent = 'Updating...';
                
                await apiRequest('/api/v1/configuration/llm', {
                    method: 'POST',
                    body: JSON.stringify({ model })
                });
                
                showToast('AI model updated successfully', 'success');
                await loadConfiguration();
                
                // Reset preview and selection
                document.getElementById('modelPreview').classList.add('hidden');
                modelSelect.value = '';
                
            } catch (error) {
                console.error('Failed to update LLM model:', error);
                showToast('Failed to update AI model', 'error');
            } finally {
                const btn = document.getElementById('updateLLMBtn');
                const modelSelect = document.getElementById('llmModelSelect');
                
                // Re-enable button only if there's a selection, otherwise keep disabled
                btn.disabled = !modelSelect.value;
                btn.textContent = 'Update';
            }
        }

        // Update video count
        async function updateVideoCount() {
            const input = document.getElementById('maxVideosInput');
            const maxVideos = parseInt(input.value);
            
            if (!maxVideos || maxVideos < 1 || maxVideos > 50) {
                showToast('Please enter a valid number between 1 and 50', 'warning');
                return;
            }
            
            try {
                const btn = document.getElementById('updateVideosBtn');
                btn.disabled = true;
                btn.textContent = 'Updating...';
                
                await apiRequest('/api/v1/configuration/videos', {
                    method: 'POST',
                    body: JSON.stringify({ max_videos: maxVideos })
                });
                
                showToast('Video count updated successfully', 'success');
                await loadConfiguration();
                
            } catch (error) {
                console.error('Failed to update video count:', error);
                showToast('Failed to update video count', 'error');
            } finally {
                const btn = document.getElementById('updateVideosBtn');
                btn.disabled = false;
                btn.textContent = 'Update';
            }
        }

        // Control bot
        async function controlBot(action) {
            try {
                // Handle restart button specifically
                if (action === 'restart') {
                    manualBotStop = false; // Clear manual stop flag on restart
                    const btn = document.getElementById('restartBotBtn');
                    if (btn) {
                        btn.disabled = true;
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '<svg class="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
                        
                        setTimeout(() => {
                            btn.disabled = false;
                            btn.innerHTML = originalText;
                        }, 2000);
                    }
                }
                
                const response = await apiRequest('/api/v1/telegram/control', {
                    method: 'POST',
                    body: JSON.stringify({ action })
                });
                
                // Show success toast
                showToast(`Bot ${action}ed successfully`, 'success');
                
                // For stop action, immediately update UI to reflect stopped state
                if (action === 'stop') {
                    updateBotStatus('stopped');
                    addRecentActivity({
                        type: 'telegram',
                        message: 'Telegram bot stopped by user',
                        status: 'stopped'
                    });
                } else if (action === 'start') {
                    updateBotStatus('running');
                    addRecentActivity({
                        type: 'telegram',
                        message: 'Telegram bot started by user',
                        status: 'running'
                    });
                }
                
                // Only reload configuration for restart actions (not start/stop)
                if (action === 'restart') {
                setTimeout(() => {
                    loadConfiguration();
                    }, 2000);
                }
                
            } catch (error) {
                console.error(`Failed to ${action} bot:`, error);
                throw error; // Re-throw for toggle error handling
            }
        }

        // Load system info
        async function loadSystemInfo() {
            try {
                const data = await apiRequest('/api/v1/system/info');
                updateMetrics(data.metrics);
                document.getElementById('systemStatus').textContent = data.status;
                document.getElementById('activeWorkflows').textContent = data.active_workflows;
            } catch (error) {
                console.error('Failed to load system info:', error);
            }
        }

        // Update metrics display
        function updateMetrics(metrics) {
            document.getElementById('totalProcessed').textContent = metrics.total_workflows || 0;
            
            const successRate = metrics.successful_workflows && metrics.total_workflows
                ? Math.round((metrics.successful_workflows / metrics.total_workflows) * 100)
                : 0;
            document.getElementById('successRate').textContent = `${successRate}%`;
            
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            toast.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Auto remove
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        }

        // Load comment posting configuration
        async function loadCommentPostingConfig() {
            try {
                const config = await apiRequest('/api/v1/configuration/details');
                updateCommentPostingUI(config);
            } catch (error) {
                console.error('Failed to load comment posting config:', error);
                showToast('Failed to load comment posting configuration', 'error');
            }
        }
        
        // Update comment posting UI based on configuration
        function updateCommentPostingUI(config) {
            const toggle = document.getElementById('commentPostingToggle');
            const statusEl = document.getElementById('commentPostingStatus');
            const statusIcon = document.getElementById('commentPostingStatusIcon');
            const setupBtn = document.getElementById('setupOAuth2Btn');
            const helpText = document.getElementById('commentPostingHelpText');
            
            // Update posting status
            const isEnabled = config.comment_posting_enabled;
            const isAuthenticated = config.oauth2_authenticated;
            const isConfigured = config.youtube_oauth_configured;
            
            toggle.checked = isEnabled;
            toggle.disabled = false;
            
            // Update status display and icon
            if (isEnabled && isAuthenticated) {
                statusEl.textContent = 'Enabled & Ready';
                statusIcon.className = 'w-3 h-3 rounded-full bg-green-500 mr-3';
                helpText.textContent = 'Comment posting is active and ready to post to YouTube';
                setupBtn.classList.add('hidden');
            } else if (isEnabled && !isAuthenticated) {
                statusEl.textContent = 'Enabled (Authentication Required)';
                statusIcon.className = 'w-3 h-3 rounded-full bg-yellow-500 mr-3';
                helpText.textContent = 'OAuth2 authentication required to post comments';
                setupBtn.classList.remove('hidden');
            } else {
                statusEl.textContent = 'Disabled';
                statusIcon.className = 'w-3 h-3 rounded-full bg-gray-500 mr-3';
                helpText.textContent = 'Comment posting is turned off';
                
                if (!isConfigured) {
                    setupBtn.classList.remove('hidden');
                } else {
                    setupBtn.classList.add('hidden');
                }
            }
        }
        
        // Toggle comment posting
        async function toggleCommentPosting() {
            const toggle = document.getElementById('commentPostingToggle');
            const enabled = toggle.checked;
            
            try {
                toggle.disabled = true;
                
                const response = await fetch('/api/v1/configuration/comment-posting', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showToast(data.message, 'success');
                    
                    // Reload configuration to update UI
                    await loadConfiguration();
                    await loadCommentPostingConfig();
                } else {
                    // Handle HTTP error responses
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.detail || `HTTP ${response.status} error`;
                    
                    if (response.status === 400 && errorMessage.includes('OAuth2')) {
                        showToast('OAuth2 setup required. Please set up OAuth2 in Settings first.', 'warning');
                        // Don't auto-redirect, let user click the setup button
                    } else {
                        showToast(errorMessage, 'error');
                    }
                    
                    // Revert toggle state
                    toggle.checked = !enabled;
                }
                
            } catch (error) {
                console.error('Failed to toggle comment posting:', error);
                showToast('Network error: Failed to toggle comment posting', 'error');
                
                // Revert toggle state
                toggle.checked = !enabled;
            } finally {
                toggle.disabled = false;
            }
        }

        // Event listeners for configuration controls
        document.getElementById('updateLLMBtn').addEventListener('click', updateLLMModel);
        document.getElementById('updateVideosBtn').addEventListener('click', updateVideoCount);
        document.getElementById('telegramBotToggle').addEventListener('change', handleTelegramBotToggle);
        document.getElementById('restartBotBtn').addEventListener('click', () => controlBot('restart'));
        document.getElementById('refreshLogsBtn').addEventListener('click', loadLogs);
        document.getElementById('clearLogsBtn').addEventListener('click', clearLogs);
        
        // Comment posting event listeners
        document.getElementById('commentPostingToggle').addEventListener('change', toggleCommentPosting);
        document.getElementById('setupOAuth2Btn').addEventListener('click', redirectToSettings);

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            initWebSocket();
            loadConfiguration();
            loadSystemInfo();
            loadLogs();
            loadCommentPostingConfig();
            initializeRecentActivity(); // Initialize Recent Activity
            
            // Refresh data every 30 seconds - but avoid auto-restart issues
            setInterval(() => {
                loadSystemInfo();
                
                // Only reload comment posting config if bot wasn't manually stopped recently
                const timeSinceLastToggle = Date.now() - lastToggleTime;
                if (!manualBotStop || timeSinceLastToggle > 60000) { // 1 minute grace period
                    // loadCommentPostingConfig(); // Still commented to prevent auto-restart
                }
                
                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    loadLogs(); // Only reload logs if WebSocket is disconnected
                }
            }, 30000);
        });
    </script>

    <script>
        // Recent Activity Functions
        function addRecentActivity(activity) {
            // Add timestamp if not provided
            if (!activity.timestamp) {
                activity.timestamp = new Date().toISOString();
            }
            
            // Add to beginning of array (most recent first)
            recentActivities.unshift(activity);
            
            // Keep only last 10 activities
            if (recentActivities.length > 10) {
                recentActivities = recentActivities.slice(0, 10);
            }
            
            // Update the display
            displayRecentActivity();
            
            // Save to localStorage
            saveRecentActivity();
        }

        function displayRecentActivity() {
            const container = document.getElementById('recentActivity');
            
            if (recentActivities.length === 0) {
                container.innerHTML = '<div class="text-xs text-gray-400 text-center py-4">No recent activity</div>';
                return;
            }

            const activityHTML = recentActivities.map(activity => {
                const time = new Date(activity.timestamp).toLocaleTimeString('en-US', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                const icon = getActivityIcon(activity.type);
                const colorClass = getActivityColor(activity.type, activity.status);
                
                return `
                    <div class="flex items-center justify-between py-1.5 px-2 rounded hover:bg-gray-700/50 transition-all duration-200">
                        <div class="flex items-center space-x-2 flex-1 min-w-0">
                            <div class="flex-shrink-0">
                                ${icon}
                            </div>
                            <div class="text-xs ${colorClass} truncate">${escapeHtml(activity.message)}</div>
                        </div>
                        <div class="text-xs text-gray-500 ml-2 flex-shrink-0">${time}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = activityHTML;
        }

        function getActivityIcon(type) {
            switch(type) {
                case 'workflow':
                    return '<div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>';
                case 'telegram':
                    return '<div class="w-2 h-2 bg-green-500 rounded-full"></div>';
                case 'config':
                case 'settings':
                    return '<div class="w-2 h-2 bg-purple-500 rounded-full"></div>';
                case 'error':
                    return '<div class="w-2 h-2 bg-red-500 rounded-full"></div>';
                case 'comment':
                    return '<div class="w-2 h-2 bg-yellow-500 rounded-full"></div>';
                case 'system':
                    return '<div class="w-2 h-2 bg-indigo-500 rounded-full"></div>';
                default:
                    return '<div class="w-2 h-2 bg-gray-500 rounded-full"></div>';
            }
        }

        function getActivityColor(type, status) {
            if (type === 'error') return 'text-red-400';
            if (type === 'workflow') {
                if (status === 'completed') return 'text-green-400';
                if (status === 'failed' || status === 'cancelled') return 'text-red-400';
                if (status === 'running') return 'text-blue-400';
            }
            if (type === 'telegram') return 'text-green-400';
            if (type === 'config' || type === 'settings') return 'text-purple-400';
            if (type === 'system') return 'text-indigo-400';
            return 'text-gray-300';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function saveRecentActivity() {
            try {
                localStorage.setItem('recentActivities', JSON.stringify(recentActivities));
            } catch (e) {
                console.log('Failed to save recent activity:', e);
            }
        }

        function loadRecentActivity() {
            try {
                const saved = localStorage.getItem('recentActivities');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (Array.isArray(parsed)) {
                        recentActivities = parsed.slice(0, 10); // Keep only last 10
                        displayRecentActivity();
                    }
                }
            } catch (e) {
                console.log('Failed to load saved activity:', e);
            }
        }

        function initializeRecentActivity() {
            // Load saved activities first
            loadRecentActivity();
            
            // Add welcome message if no activities exist
            if (recentActivities.length === 0) {
                addRecentActivity({
                    type: 'system',
                    message: 'Dashboard loaded successfully'
                });
            }
        }

        // Initialize Recent Activity when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            initializeRecentActivity();
        });
    </script>
</body>
</html> 